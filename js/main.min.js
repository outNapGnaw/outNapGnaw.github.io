function log(e){console.log(e)}function popup(e){$("#noti-box").html(e),$("#noti-box").fadeIn().delay(0).fadeOut()}function openFullscreen(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}function getOS(){var e="unknown";return-1!==navigator.appVersion.indexOf("Win")?e="win":-1!==navigator.appVersion.indexOf("Mac")?e="mac":-1!==navigator.userAgent.indexOf("Linux")?e="linux":-1!==navigator.userAgent.indexOf("Android")&&(e="android"),e}function getBrowser(){var e="unknown";return-1!==navigator.userAgent.indexOf("Firefox")&&(e="firefox"),-1!==navigator.userAgent.indexOf("Chrome")&&(e="chrome"),-1!==navigator.userAgent.indexOf("Edge")&&(e="edge"),-1!==navigator.userAgent.indexOf("Version/")&&(e="safari"),-1!==navigator.userAgent.indexOf("UCBrowser")&&(e="uc"),e}function isPortrait(){switch(window.orientation){case 0:case 180:return!0}return"portrait-primary"===(screen.msOrientation||screen.mozOrientation||(screen.orientation||{}).type)}function fixElementLayout(e,t,n){var a=e.width(),o=e.height(),i="translate(-50%, -50%) ";if(isPortrait()){i+="rotate(90deg) ";var c=n;n=t,t=c,isLayoutSwitched=!0}else isLayoutSwitched=!1;i+="scale("+Math.min(t/a,n/o)+") ",e.css("transform",i),e.css("-webkit-transform",i),e.css("-moz-transform",i)}function loadRoomID(){return localStorage.getItem("roomID")}function saveRoomID(e){localStorage.setItem("roomID",e)}function copyToClipboard(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}var DEBUG=!1,KEY_BIT=["a","b","select","start","up","down","left","right"],INPUT_FPS=100,INPUT_STATE_PACKET=1,PINGPONGPS=5,MENU_TOP_POSITION=102,ICE_TIMEOUT=2e3,screenState="loader",gameList=[],gameIdx=5,gamePickerTimer=null,keyState={a:!1,b:!1,start:!1,select:!1,up:!1,down:!1,left:!1,right:!1},unchangePacket=INPUT_STATE_PACKET,gameInputTimer=null,pc=void 0,inputChannel=void 0,localSessionDescription="",remoteSessionDescription="",conn=void 0,menuDrag=null,menuTop=MENU_TOP_POSITION,isLayoutSwitched=!1,gameReady=!1,inputReady=!1,audioReady=!1,iceSuccess=!0,iceSent=!1,defaultICE=[{urls:"stun:stun.l.google.com:19302"}];function keyboard(e,t){switch(console.log("handle nes"+t),t){case"up":e(1,jsnes.Controller.BUTTON_UP);break;case"down":e(1,jsnes.Controller.BUTTON_DOWN);break;case"left":e(1,jsnes.Controller.BUTTON_LEFT);break;case"right":e(1,jsnes.Controller.BUTTON_RIGHT);break;case"a":e(1,jsnes.Controller.BUTTON_A);break;case"b":e(1,jsnes.Controller.BUTTON_B);break;case"select":e(1,jsnes.Controller.BUTTON_SELECT);break;case"start":e(1,jsnes.Controller.BUTTON_START)}}function doButtonDown(e){console.log(e+" doButtonDown"),$("#btn-"+e).addClass("pressed"),"menu"===screenState?"up"!==e&&"down"!==e||startGamePickerTimer(e):"game"===screenState&&keyboard(nes.buttonDown,e)}function doButtonUp(e){if($("#btn-"+e).removeClass("pressed"),"menu"===screenState)switch(e){case"up":case"down":stopGamePickerTimer();break;case"join":case"a":case"b":case"start":case"select":startGame(gameIdx);break;case"quit":popup("You are already in menu screen!");break;case"load":popup("Lets play to load game!");break;case"save":popup("Lets play to save game!")}else"game"===screenState&&(console.log("screenState->"+e),keyboard(nes.buttonUp,e));"help"===e&&hideHelpScreen()}function reloadGameMenu(){log("Load game menu"),gameList.sort(function(e,t){return e.name>t.name?1:-1});var t=$("#menu-container");t.html(""),gameList.forEach(function(e){t.append('<div class="menu-item unselectable" unselectable="on"><div><span>'+e.name+"</span></div></div>")})}function showMenuScreen(){$("#game-screen").hide(),$("#menu-screen").hide(),$("#btn-save").hide(),$("#btn-load").hide(),$("#btn-join").html("play"),$("#game-screen").show().delay(0).fadeOut(0,function(){log("Loading menu screen"),$("#menu-screen").fadeIn(0,function(){pickGame(gameIdx),screenState="menu"})})}function pickGame(e){e<0&&(e=gameList.length-1),e>=gameList.length&&(e=0);var t=$("#menu-container");t.css("transition","top 0.2s"),t.css("-moz-transition","top 0.2s"),t.css("-webkit-transition","top 0.2s"),menuTop=MENU_TOP_POSITION-36*e,t.css("top",menuTop+"px"),$(".menu-item .pick").removeClass("pick"),$(".menu-item:eq("+e+") span").addClass("pick"),log("> [Pick] game "+((gameIdx=e)+1)+"/"+gameList.length+" - "+gameList[gameIdx].name)}function stopGamePickerTimer(){null!==gamePickerTimer&&(log("Stop game picker timer"),clearInterval(gamePickerTimer),gamePickerTimer=null)}function startGamePickerTimer(e){null===gamePickerTimer&&(pickGame(gameIdx+("up"===e?-1:1)),log("Start game picker timer"),gamePickerTimer=setInterval(function(){pickGame(gameIdx+("up"===e?-1:1))},200))}var joystickMap=void 0,joystickState=void 0,joystickIdx=void 0,joystickTimer=null;function checkJoystickAxisState(e,t){joystickState[e]!==t&&(!0===(joystickState[e]=t)?doButtonDown(e):doButtonUp(e))}function checkJoystickState(){var n=navigator.getGamepads()[joystickIdx];if(n){var e=n.axes[0],t=n.axes[1];checkJoystickAxisState("left",e<=-.5),checkJoystickAxisState("right",.5<=e),checkJoystickAxisState("up",t<=-.5),checkJoystickAxisState("down",.5<=t),Object.keys(joystickMap).forEach(function(e){var t=!1;t=navigator.webkitGetGamepads?1===n.buttons[e]:0<n.buttons[e].value||!0===n.buttons[e].pressed,joystickState[e]!==t&&(!0===(joystickState[e]=t)?doButtonDown(joystickMap[e]):doButtonUp(joystickMap[e]))})}}window.addEventListener("gamepadconnected",function(e){var t=e.gamepad;log("Gamepad connected at index "+t.index+": "+t.id+". "+t.buttons.length+" buttons, "+t.axes.length+" axes."),joystickIdx=t.index;var n=getOS(),a=getBrowser();joystickMap="android"===n?{2:"a",0:"b",3:"start",4:"select",10:"load",11:"save",8:"help",9:"quit",12:"up",13:"down",14:"left",15:"right"}:{0:"a",1:"b",2:"start",3:"select",8:"load",9:"save",6:"help",7:"quit",12:"up",13:"down",14:"left",15:"right"},"android"!==n||"firefox"!==a&&"uc"!==a||(joystickMap={0:"a",1:"b",2:"start",3:"select",8:"load",9:"save",6:"help",7:"quit",12:"up",13:"down",14:"left",15:"right"}),"win"===n&&"firefox"===a&&(joystickMap={1:"a",2:"b",0:"start",3:"select",8:"load",9:"save",6:"help",7:"quit"}),"mac"===n&&"safari"===a&&(joystickMap={1:"a",2:"b",0:"start",3:"select",8:"load",9:"save",6:"help",7:"quit",14:"up",15:"down",16:"left",17:"right"}),"mac"===n&&"firefox"===a&&(joystickMap={1:"a",2:"b",0:"start",3:"select",8:"load",9:"save",6:"help",7:"quit",14:"up",15:"down",16:"left",17:"right"}),joystickState={left:!1,right:!1,up:!1,down:!1},Object.keys(joystickMap).forEach(function(e){joystickState[e]=!1}),null!==joystickTimer&&clearInterval(joystickTimer),joystickTimer=setInterval(checkJoystickState,10)}),window.addEventListener("gamepaddisconnected",function(t){clearInterval(joystickTimer),log("Gamepad disconnected at index "+e.gamepad.index)});var KEYBOARD_MAP={37:"left",38:"up",39:"right",40:"down",90:"a",88:"b",67:"start",86:"select",81:"quit",83:"save",87:"join",65:"load",70:"full",72:"help"};$("body").on("keyup",function(e){e.keyCode in KEYBOARD_MAP&&doButtonUp(KEYBOARD_MAP[e.keyCode])}),$("body").on("keydown",function(e){e.keyCode in KEYBOARD_MAP&&doButtonDown(KEYBOARD_MAP[e.keyCode])});var MAX_DIFF=20,vpadState={up:!1,down:!1,left:!1,right:!1};$(".btn, .btn-big").each(function(){vpadState[$(this).attr("value")]=!1});var vpadTouchIdx=null,vpadTouchDrag=null,vpadHolder=$("#circle-pad-holder"),vpadCircle=$("#circle-pad");function resetVpadState(){checkVpadState("up",!1),checkVpadState("down",!1),checkVpadState("left",!1),checkVpadState("right",!1),vpadTouchIdx=vpadTouchDrag=null,$(".dpad").removeClass("pressed")}function checkVpadState(e,t){t!==vpadState[e]&&((vpadState[e]=t)?doButtonDown(e):doButtonUp(e))}function handleVpadJoystickDown(e){vpadCircle.css("transition","0s"),vpadCircle.css("-moz-transition","0s"),vpadCircle.css("-webkit-transition","0s"),e.changedTouches&&(resetVpadState(),vpadTouchIdx=e.changedTouches[0].identifier,e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY),vpadTouchDrag={x:e.clientX,y:e.clientY}}function handleVpadJoystickUp(e){null!==vpadTouchDrag&&(vpadCircle.css("transition",".2s"),vpadCircle.css("-moz-transition",".2s"),vpadCircle.css("-webkit-transition",".2s"),vpadCircle.css("transform","translate3d(0px, 0px, 0px)"),vpadCircle.css("-moz-transform","translate3d(0px, 0px, 0px)"),vpadCircle.css("-webkit-transform","translate3d(0px, 0px, 0px)"),resetVpadState())}function handleVpadJoystickMove(e){if(null!==vpadTouchDrag){if(e.changedTouches){for(var t=0;t<e.changedTouches.length;t++)e.changedTouches[t].identifier===vpadTouchIdx&&(e.clientX=e.changedTouches[t].clientX,e.clientY=e.changedTouches[t].clientY);if(void 0===e.clientX||void 0===e.clientY)return}var n=e.clientX-vpadTouchDrag.x,a=e.clientY-vpadTouchDrag.y,o=Math.atan2(a,n),i=Math.min(MAX_DIFF,Math.hypot(n,a)),c=i*Math.cos(o),s=i*Math.sin(o);isLayoutSwitched&&(tmp=c,c=s,s=-tmp),style="translate("+c+"px, "+s+"px)",vpadCircle.css("transform",style),vpadCircle.css("-webkit-transform",style),vpadCircle.css("-moz-transform",style);var r=c/MAX_DIFF,u=s/MAX_DIFF;checkVpadState("left",r<=-.5),checkVpadState("right",.5<=r),checkVpadState("up",u<=-.5),checkVpadState("down",.5<=u)}}function handleButtonDown(e){doButtonDown($(this).attr("value"))}function handleButtonUp(e){console.log("++++++handleButtonUp++++++"),doButtonUp($(this).attr("value"))}vpadHolder.on("mousedown",handleVpadJoystickDown),vpadHolder.on("touchstart",handleVpadJoystickDown),vpadHolder.on("touchend",handleVpadJoystickUp),$(".btn").on("touchstart",handleButtonDown),$(".btn").on("touchend",handleButtonUp);var menuTouchIdx=null,menuTouchDrag=null,menuTouchTime=null;function handleMenuDown(e){e.changedTouches&&(menuTouchIdx=e.changedTouches[0].identifier,e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY),menuTouchDrag={x:e.clientX,y:e.clientY},menuTouchTime=Date.now()}function handleMenuMove(e){if(null!==menuTouchDrag){if(e.changedTouches){for(var t=0;t<e.changedTouches.length;t++)e.changedTouches[t].identifier===menuTouchIdx&&(e.clientX=e.changedTouches[t].clientX,e.clientY=e.changedTouches[t].clientY);if(null==e.clientX||null==e.clientY)return}var n=$("#menu-container");n.css("transition",""),n.css("-moz-transition",""),n.css("-webkit-transition",""),isLayoutSwitched?n.css("top",menuTop-(-menuTouchDrag.x+e.clientX)+"px"):n.css("top",menuTop-(menuTouchDrag.y-e.clientY)+"px")}}function handleMenuUp(e){if(null!==menuTouchDrag){if(e.changedTouches){if(e.changedTouches[0].identifier!==menuTouchIdx)return;e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY}var t=Date.now()-menuTouchTime;newY=isLayoutSwitched?-menuTouchDrag.x+e.clientX:menuTouchDrag.y-e.clientY,t<200&&(newY=newY/t*250),menuTop-=newY,idx=Math.round((menuTop-MENU_TOP_POSITION)/-36),pickGame(idx),menuTouchDrag=null}}function handleWindowMove(e){if(e.preventDefault(),handleVpadJoystickMove(e),handleMenuMove(e),e.changedTouches)for(var t=0;t<e.changedTouches.length;t++)if(e.changedTouches[t].identifier!==menuTouchIdx&&e.changedTouches[t].identifier!==vpadTouchIdx){var n=document.elementFromPoint(e.changedTouches[t].clientX,e.changedTouches[t].clientY);n.classList.contains("btn")?$(n).trigger("touchstart"):$(".btn").trigger("touchend")}}function handleWindowUp(e){handleVpadJoystickUp(e),handleMenuUp(e),$(".btn").trigger("touchend")}$("#menu-screen").on("touchstart",handleMenuDown),$("#menu-screen").on("touchend",handleMenuUp),window.addEventListener("touchmove",handleWindowMove,{passive:!1});var canvas_ctx,image,framebuffer_u8,framebuffer_u32,startGame=function(e){return"menu"==screenState&&(screenState="game",$("#menu-screen").hide(),$("#game-screen").show(),nes_load_url("nes-canvas",gameList[e].file),!0)},SCREEN_WIDTH=256,SCREEN_HEIGHT=240,FRAMEBUFFER_SIZE=SCREEN_WIDTH*SCREEN_HEIGHT,AUDIO_BUFFERING=512,SAMPLE_COUNT=4096,SAMPLE_MASK=SAMPLE_COUNT-1,audio_samples_L=new Float32Array(SAMPLE_COUNT),audio_samples_R=new Float32Array(SAMPLE_COUNT),audio_write_cursor=0,audio_read_cursor=0,nes=new jsnes.NES({onFrame:function(e){for(var t=0;t<FRAMEBUFFER_SIZE;t++)framebuffer_u32[t]=4278190080|e[t]},onAudioSample:function(e,t){audio_samples_L[audio_write_cursor]=e,audio_samples_R[audio_write_cursor]=t,audio_write_cursor=audio_write_cursor+1&SAMPLE_MASK}});function onAnimationFrame(){window.requestAnimationFrame(onAnimationFrame),image.data.set(framebuffer_u8),canvas_ctx.putImageData(image,0,0),nes.frame()}function audio_remain(){return audio_write_cursor-audio_read_cursor&SAMPLE_MASK}function audio_callback(e){var t=e.outputBuffer,n=t.length;audio_remain()<AUDIO_BUFFERING&&nes.frame();for(var a=t.getChannelData(0),o=t.getChannelData(1),i=0;i<n;i++){var c=audio_read_cursor+i&SAMPLE_MASK;a[i]=audio_samples_L[c],o[i]=audio_samples_R[c]}audio_read_cursor=audio_read_cursor+n&SAMPLE_MASK}function nes_init(e){var t=document.getElementById(e);canvas_ctx=t.getContext("2d"),image=canvas_ctx.getImageData(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),canvas_ctx.fillStyle="black",canvas_ctx.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);var n=new ArrayBuffer(image.data.length);framebuffer_u8=new Uint8ClampedArray(n),framebuffer_u32=new Uint32Array(n),window.AudioContext=window.AudioContext||window.webkitAudioContext;var a=new window.AudioContext,o=a.createScriptProcessor(AUDIO_BUFFERING,0,2);o.onaudioprocess=audio_callback,o.connect(a.destination)}function nes_boot(e){nes.loadROM(e),window.requestAnimationFrame(onAnimationFrame)}function nes_load_data(e,t){nes_init(e),nes_boot(t)}function nes_load_url(t,e){$("#game-loading").show(),$.ajax({url:"/roms/"+e,beforeSend:function(e){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e){nes_init(t),nes_boot(e)},error:function(e){console.log(e)},complete:function(){$("#game-loading").hide()}})}function fixScreenLayout(){var e=.9*$(document).width(),t=.9*$(document).height();if("android"===getOS())e=$(document).width(),t=$(document).height();fixElementLayout($("#gamebody"),e,t);var n=$("#ribbon"),a="";if(isLayoutSwitched){a="rotate(90deg)";n.css("bottom",0),n.css("top","")}else n.css("bottom",""),n.css("top",0);n.css("transform",a),n.css("-webkit-transform",a),n.css("-moz-transform",a)}$(window).on("resize",fixScreenLayout),$(window).on("orientationchange",fixScreenLayout);var getGameList=function(){return["1944","冒险岛3","合金装备2","动作-马戏团","恶魔城3","超级玛丽2","娱乐-五子棋","洛克人3","忍者神龟3","娱乐-中国象棋(中文)","双截龙3","超级玛丽3","动作-坦克大战","魂斗罗3","水上魂斗罗","赛车-坦克飞机","冒险岛4","空中魂斗罗1","动作-飞碟吸坦克","洛克人4","勇者斗恶龙1","动作-马戏团无限命版","洛克人5","宇宙巡航舰1","踢王","洛克人6","忍者龙剑传1","炸弹人","沙罗曼蛇","摩登原始人1","恶魔城1","雪人兄弟","松鼠大作战1","双截龙1","三目童子","柯纳米世界1","洛克人1","中东战争","忍者龙剑传2","蝙蝠侠1","坦克大战","勇者斗恶龙2","魂斗罗1","影子传说","宇宙巡航舰2","冒险岛2","忍者龙牙","摩登原始人2","恶魔城2","绿色兵团","松鼠大作战2","洛克人2","赤色要塞","柯纳米世界2","双截龙2","忍者神龟1","空中魂斗罗2","炸弹人2","合金装备1","勇者斗恶龙3","蝙蝠侠2","超级玛丽1","忍者龙剑传3","魂斗罗2","忍者神龟2"].map(function(e){return{file:e+".nes",name:e}})};$(document).ready(function(){fixScreenLayout(),gameList=getGameList(),reloadGameMenu(),showMenuScreen();new VConsole});